<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta charset="utf-8">
    <title>RCSP-Interaction Demo - Parsing of PDB files</title>

        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>        

	<script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>        
	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.css" />

	<script type='text/javascript' src="http://cdn.datatables.net/1.10.1/js/jquery.dataTables.min.js"></script>        
	<link rel="stylesheet" href="http://cdn.datatables.net/1.10.1/css/jquery.dataTables.css" />

        <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
        <link href="http://www.bootply.com/bootply/themes/metroid/theme.css" type="text/css" rel="stylesheet">

        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        
        <style type="text/css">
            body {  padding-top: 50px;}h1,h2,h3,h4 {  color: #810988}
        </style>
</head>

<body>
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">PDBs via JavaScript</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Home</a></li>
        <li><a href="#about">About</a></li>
        <li><a href="#contact">Contact</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div>

<div class="container">
  
  <div>
    <h1>RCSP-Interaction Demo - Parsing of PDB files</h1>
    <p class="lead">Enter a PDB id (if you dont have any ideas: 1F34 is a nice protein, the current
 default 2OXP is a rather small one. 4N9F is huge with more than 10,000 residues.) Then hit "Load PDB". To display the parsed results, click on the corresponding button.<br>
Note that displaying as a HTML table can take quite long (Datatables is not meant to be fed with a single huge bulk of data from the client side. But it works for now.)<br>
<strong>Note that parsing of the PDB is surprisingly fast!</strong><br>
For 4N9F with its more than 60,000 atoms, parsing took only 0.5 seconds and displaying as HTML was done after 17 seconds.
</p>



<div class="ui-widget">
	<button id="bt_load">Load PDB</button>
	<input id="inputPDBid" type="text" value="2OXP">
	<button id="bt_display">Display PDB</button>    
</div>
<br>

<div id="errorlog_outer" class="ui-widget">
	<div class="ui-state-error ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
		<span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
		<p id="errorlog"></p>
	</div>
</div>


<div id="infolog_outer" class="ui-widget">
	<div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
		<span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		<p id="infolog"></p>
	</div>
</div>

		<div class="container">
<table id="example" class="display ui-widget" style="width:100%;">
	<thead>
	    <tr>
		<th>ATOM</th>
		<th>serial</th>
		<th>name</th>
		<th>altLoc</th>
		<th>resName</th>
		<th>chainID</th>
		<th>resSeq</th>
		<th>iCode</th>
		<th>x</th>
		<th>y</th>
		<th>t</th>
		<th>occupancy</th>
		<th>tempFactor</th>
		<th>ignored</th>
		<th>element</th>
		<th>charge</th>
	    </tr>
	</thead>

        <tbody>
    </tbody>
</table>
</div>
<br>
<hr>
<a href="http://jsfiddle.net/njbusz3c/2/" target="_blank">This site as a fiddle</a>
  </div>
  
</div><!-- /.container -->





<script type="text/javascript"> 
$(function() {

logRuntimeToConsole = function(f) {
	return function() {
	    var start = new Date().getTime();
	    var result = f.apply(this, arguments)
	    var end = new Date().getTime();
	    var time = end - start;
	    console.info('Execution time of '+f.name+': ' + time + "ms");
	    return result;
	}
}

PDBDATA = new function() {
	this.pdbdata = {};
	this.setPDBdata = function(newDATA) {
		this.pdbdata = newDATA;
		//displayPDB(this.pdbdata);
	}
};

var PDBFIELDNAMES = {
        1: ["ATorHET", String.trim, ""],
        2: ["serial", parseInt, NaN],
        3: ["atom", String.trim, ""],
        4: ["altloc", String.trim, ""],
        5: ["resname",String.trim, ""],
        6: ["chainid",String.trim, ""],
        7: ["resseq",parseInt, ""],
        8: ["icode",String.trim, ""],
        9: ["x",parseFloat, NaN],
       10: ["y",parseFloat, NaN],
       11: ["z",parseFloat, NaN],
       12: ["occupancy",parseFloat, NaN],
       13: ["tempFactor",parseFloat, NaN],
       14: ["ignored",parseFloat, ""],
       15: ["element",String.trim, ""],
       16: ["charge",parseFloat, NaN],
    };

    
$("#errorlog_outer").hide();
$("#infolog_outer").hide();    
$("#bt_load").button();
$("#inputPDBid").autocomplete();
$("#bt_display").button({ disabled: true });

$(document).ajaxError(function(e,xhr,opt){
	$("#errorlog").text("Error requesting " + opt.url + ": " + xhr.status + " " + xhr.statusText).show();
        $("#errorlog_outer").show();
});
    
$("#bt_load").click(function(){
	var query = $("#inputPDBid").val();
	var url = "http://www.pdb.org/pdb/files/" + query + ".pdb";
	var that = this;
	$("#errorlog_outer").hide();
	$("#infolog_outer").hide();
        $("#bt_display").button({ disabled: true });

   	var start = new Date().getTime();
    
	$.get(url, function(ret) {
            var end = new Date().getTime();
            var time = end - start;

	    console.debug("got pdb data for " + query + " after " + time + " ms" );                        
            $("#infolog").text("Received PDB data").show();
            $("#infolog_outer").show();
	    proccessPDB(ret);
	    $("#bt_display").button({ disabled: false });
	    $("#infolog").text("Received and processed PDB data").show();

	}).fail(function() {
	    console.error("could not retrive PDB data for " + this.pdbcode);
	})               

});
    
$("#bt_display").click(function(){
	displayPDB(PDBDATA.pdbdata);
});

function proccessPDB(pdbdata) {
    console.info("proccessPDB");

    var re = /(ATOM  |HETATM)\s*(\d+)\s([A-Z0-9 ]{4})\s*([\w ])([A-Z]{3})\s(\w)\s*(\d*)([A-Za-z ])\s+([+-]?[\d]+\.\d{3})\s*([+-]?[\d]+\.\d{3})\s*([+-]?[\d]+\.\d{3})\s*([+-]?[\d]+\.\d{2})\s+([+-]?[\d]+\.\d{2})([\s\d+-\.]*)(\w{0,2}).*/gm;
        
    var m;
    var line_no = 0;
    var max_lines = 0;
    var result = [];
    while ((m = re.exec(pdbdata)) != null) {
        line_no += 1;
        if (m.index === re.lastIndex) {
            re.lastIndex++;
        }
        var atom = {};
        for (var i = 1; i < 17; ++i) {
            var field = PDBFIELDNAMES[i];
            var key = field[0];
            var val = field[1](m[i]);
            atom[key] = val;
        }
        if (line_no < max_lines)
            console.info(atom);
        if (line_no == max_lines)
            console.info("...");
        result.push(atom);
    }    
    
    PDBDATA.setPDBdata(result);

};
proccessPDB = logRuntimeToConsole(proccessPDB);

displayPDB = function(parsedPDB) {
    console.info("displayPDB", parsedPDB.length);
    $("#infolog_outer").hide();
    var counter = 1;
    $('#example').DataTable().destroy();
    var t = $('#example').DataTable({
	 "data": parsedPDB,
         "columns": cols        
   });
    
    var i = 0;
}
displayPDB = logRuntimeToConsole(displayPDB);

var cols = [];
$.each(PDBFIELDNAMES, function(i, c) {
        cols.push({data:c[0]});
});
    

var t = $('#example').DataTable({
 "columns": cols        
});




});
</script>        
</body>
